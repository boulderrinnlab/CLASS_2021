---
title: "Global peak properties"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(GenomicRanges)
library(Gviz)
library(ggpubr)
library(BiocManager)


source("~/CLASS/Justin/util/intersect_functions.R")
source("~/CLASS/Justin/CLASS_2021/util/plotting_functions.R")
source("~/CLASS/Justin/CLASS_2021/util/_setup.R")
```

```{r}
base_path <- "~/CLASS/Justin/CLASS_2021/analysis/00_consensus_peaks/results"
peak_list <- import_peaks(file.path(base_path,
                                    "filtered_consensus/"))

```

Scatter plot of normalized number of DBP bound to each reservoir in K562 and those in HEPG2
```{r}
po_2020_df <- read.csv(file = '/scratch/Shares/rinnclass/data/2020_peak_occurence_df.csv')
po_2021_df <- read.csv(file = '~/CLASS/Justin/CLASS_2021/analysis/01_global_peak_properties/results/peak_occurence_dataframe.csv')

po_2020_df <- po_2020_df %>%
  mutate(num_dbp_norm_K562 = number_of_dbp/length(occ_matrix_K562$dbp))

po_2021_df <- po_2021_df %>%
  mutate(num_dbp_norm_HEPG2 = number_of_dbp/nrow(occ_matrix_HEPG2))

high_binder_df <- po_2021_df[po_2021_df$number_of_dbp >= 200&po_2021_df$number_of_dbp <= 350,]
high_2020_df <- po_2020_df[po_2020_df$gene_id %in% high_binder_df$gene_id,]

reservoir_2020 <- po_2020_df %>% filter(po_2020_df$reservoir == 1)
filtered_df <- po_2021_df[po_2021_df$gene_id %in% reservoir_2020$gene_id,]

filtered_df$num_dbp_norm_K562 <- reservoir_2020$num_dbp_norm_K562
reservoir_high_df <- filtered_df[filtered_df$gene_id %in% high_bound_promoters$gene_id,]

ggplot(reservoir_high_df, aes(x = num_dbp_norm_K562, 
                 y = num_dbp_norm_HEPG2,
                 color = gene_type,
                 label = gene_name)) +
  geom_hex(bins = 40, alpha = 0.5)+
  ggtitle("Normalized num of dbp bound to each reservoir in HEPG2 vs in K562",
          subtitle = "Color by Gene Type") 
ggsave("~/CLASS/Justin/CLASS_2021/analysis/02_content_of_peaks_per_promoter/figures/Normalized_distribution_num_dbp_HEPG2_K562.png", height = 5, width = 8)

g <- ggplot(high_binder_df, aes(x = num_dbp_norm_HEPG2, color = gene_type))

#AES layer will know to make a histogram since there is only one set of values for x.
g + geom_density(alpha = 0.2,  fill = "#424242") +
  xlab(expression("Number of DBPs")) +
  ylab(expression("Density")) +
  ggtitle("DBPs distribution of high binder in HEPG2",
          subtitle = "mRNA and lncRNA genes") 
ggsave("~/CLASS/Justin/CLASS_2021/analysis/02_content_of_peaks_per_promoter/figures/Distribution_high_genes_num_dbp_HEPG2.png", height = 5, width = 8)

g <- ggplot(high_2020_df, aes(x = num_dbp_norm_K562, color = gene_type))

#AES layer will know to make a histogram since there is only one set of values for x.
g + geom_density(alpha = 0.2,  fill = "#424242") +
  xlab(expression("Normalized Number of DBPs")) +
  ylab(expression("Density")) +
  ggtitle("DBPs distribution of high binder in K562",
          subtitle = "mRNA and lncRNA genes") 
ggsave("~/CLASS/Justin/CLASS_2021/analysis/02_content_of_peaks_per_promoter/figures/Distribution_high_genes_num_dbp_K562.png", height = 5, width = 8)
```


```{r}

peak_occurence_df <- po_2021_df

g <- ggplot(p0_2021_df, aes(x = num_dbp_norm_HEPG2,
                            color = gene_type))

#AES layer will know to make a histogram since there is only one set of values for x.
g + geom_density(alpha = 0.2, fill = "#424242") +
  xlab(expression("Number of DBPs")) +
  ylab(expression("Density")) +
  ggtitle("DBPs distribution",
          subtitle = "mRNA and lncRNA genes") 

g <- ggplot(po_2020_df, aes(x = num_dbp_norm_K562,
                            color = gene_type))

#AES layer will know to make a histogram since there is only one set of values for x.
g + geom_density(alpha = 0.2, fill = "#424242") +
  xlab(expression("Number of DBPs")) +
  ylab(expression("Density")) +
  ggtitle("DBPs distribution",
          subtitle = "mRNA and lncRNA genes") 

```


