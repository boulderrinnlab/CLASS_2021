---
title: "Global peak properties"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(GenomicRanges)
library(Gviz)
library(ggpubr)
library(BiocManager)

library(regioneR)
library(ggdendro)
install.packages("pals")
library(pals)    
source("~/CLASS/Justin/util/intersect_functions.R")
source("~/CLASS/Justin/CLASS_2021/util/plotting_functions.R")
source("~/CLASS/Justin/CLASS_2021/util/_setup.R")
```

```{r}
base_path <- "~/CLASS/Justin/CLASS_2021/analysis/00_consensus_peaks/results"
peak_list <- import_peaks(file.path(base_path,
                                    "filtered_consensus/"))

```

Plot peak_occurence_df
```{r}
g <- ggplot(peak_occurence_df, aes(x = number_of_dbp))

#AES layer will know to make a histogram since there is only one set of values for x.
g + geom_density(alpha = 0.2, color = "#424242", fill = "#424242") +
  xlab(expression("Number of DBPs")) +
  ylab(expression("Density")) +
  ggtitle("DBPs distribution",
          subtitle = "mRNA and lncRNA genes") 

```

Dive deeper into promoters with num of DBPs >= 170
```{r}
high_bound_promoters <- peak_occurence_df %>% filter(peak_occurence_df$number_of_dbp >= 200, peak_occurence_df$number_of_dbp <= 350)

ggplot(high_bound_promoters, aes(
      x = gene_name,
      y = number_of_dbp)) +
        geom_bar(stat = "identity")

high_bound_id <- high_bound_promoters$gene_id 

filtered_promoters <- lncrna_mrna_promoters[lncrna_mrna_promoters$gene_id %in% high_bound_id]
#length(filtered_promoters)
high_bound_occur <- count_peaks_per_feature(filtered_promoters, peak_list, 
                                               type = "occurrence")

filtered_promoters[1]
features_names <- filtered_promoters$gene_name
peak_names <- names(peak_list)
temp <- matrix(0, ncol = length(filtered_promoters), nrow = length(peak_list))
rownames(temp) <- peak_names
colnames(temp) <- features_names
temp[1,features_names[1]]

peak_store <- get_overlapping_peaks(filtered_promoters, peak_list, 1)
colnames(peak_store)
peak_store[peak_names[1],features_names[10]]
pcm <- peak_store %>%
  dplyr::select()
high_bound_df <- as.data.frame(as.table(peak_store))
write_csv(high_bound_df, "/scratch/Shares/rinnclass/Justin/CLASS_2021/analysis/02_content_of_peaks_per_promoter/results/interesting_feature_peaks_dataframe.csv")

```
Permutation Test
```{r}
high_bound_df
hg38 <- getGenome("hg38")
suppressWarnings(pt <- overlapPermTest(A = filtered_promoters, 
                                       B = peak_list, 
                                       ntimes = 1000, 
                                       non.overlapping = FALSE, 
                                       verbose = TRUE,
                                       genome = hg38,
                                       alternative =  "auto", 
                                       mc.cores = 8))


```
RowSum, ColumnSum of peak_store matrix
```{r}
po_2020_df <- read.csv(file = '/scratch/Shares/rinnclass/data/2020_peak_occurence_df.csv')
po_2021_df <- read.csv(file = '~/CLASS/Justin/CLASS_2021/analysis/01_global_peak_properties/results/peak_occurence_dataframe.csv')
peak_occurence_df <- po_2021_df

head(po_2020_df)
dbp_promoter_binding_table <- read.csv(file = '/scratch/Shares/rinnclass/data/dbp_promoter_binding_table.csv')

length(dbp_promoter_binding_table$dbp)
```

Scatter plot of percentage of reservoirs in K562 and those in HEPG2
```{r}
#get the reservoirs in 2020 peak_occurence_df
reservoir_2020 <- po_2020_df %>% filter(po_2020_df$reservoir == 1) 
reservoir_name_list <- reservoir_2020$gene_name
#get the reserviors in 2021 peak_occurence_df
reservoir_2021 <- po_2021_df %>% filter(po_2021_df$gene_name %in% reservoir_name_list)

#normalize by the total number of DBP
normalized_2020 <- reservoir_2020 %>%
  dplyr::select(gene_id, gene_type, number_of_dbp) %>%
  dplyr::mutate(dbp_norm = number_of_dbp/length(dbp_promoter_binding_table$dbp)) %>%
  dplyr::rename(norm_num_dbp_HEPG2 = dbp_norm)


normalized_2021 <-reservoir_2021 %>%
  dplyr::select(gene_id, gene_type, number_of_dbp) %>%
  dplyr::mutate(dbp_norm = number_of_dbp/length(peak_names)) %>%
  dplyr::rename(norm_num_dbp_K562 = dbp_norm)

comparison_df <- merge(normalized_2020, normalized_2021, by="gene_id")
comparison_df$ratio_of_HEPG2_K562 <- comparison_df$norm_num_dbp_HEPG2/comparison_df$norm_num_dbp_K562

mean(comparison_df$norm_num_dbp_HEPG2)
mean(comparison_df$norm_num_dbp_K562)
ggplot(comparison_df, aes(x = norm_num_dbp_K562, 
                 y = norm_num_dbp_HEPG2,
                 color = ratio_of_HEPG2_K562)) +
  geom_point()+
  geom_vline(xintercept = 0.4)+
  geom_hline(yintercept = 0.5)+
  #geom_abline(slope = 0.75, intercept = 0, color="red", 
                 #linetype="dashed") +
  #facet_wrap(norm_num_dbp_K562~norm_num_dbp_HEPG2)
  geom_smooth(method = "lm", span = 0.3)+
  #scale_color_gradientn(colors = pals::ocean.amp(20)) +
  ggtitle("Normalized num of dbp bound to each reservoir in HEPG2 vs in K562",
          subtitle = "Colored by ratio")
ggsave("~/CLASS/Justin/CLASS_2021/analysis/02_content_of_peaks_per_promoter/figures/Normalized_distribution_num_dbp_HEPG2_K562.png", height = 5, width = 8)
?geom_abline
```


