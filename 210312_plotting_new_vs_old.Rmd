---
title: "Global peak properties"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(GenomicRanges)
source("util/intersect_functions.R")
source("util/plotting_functions.R")
source("util/_setup.R")
library(Gviz)
library(ggplot2)

```

Open dataframe

```{r}

# scatterplot x: K562 % dbp and HepG (460 DBP)

peak_occurence_df_2020 <- read.csv(file = '/scratch/Shares/rinnclass/data/2020_peak_occurence_df.csv')
head(peak_occurence_df_2020)

peak_occurence_df_new <- read.csv(file = '/scratch/Shares/rinnclass/Nina/CLASS_2021/analysis/01_global_peak_properties/results/peak_occurence_dataframe.csv')
head(peak_occurence_df_new)


```

plot Promoter binding events 


```{r}
# new data
g <- ggplot(peak_occurence_df_new, aes(x = number_of_dbp))

#AES layer will know to make a histogram since there is only one set of values for x.
g + geom_density(alpha = 0.2, color = "#424242", fill = "#424242") +
  theme_paperwhite() +
  xlab(expression("Number of DBPs")) +
  ylab(expression("Density")) +
  ggtitle("Promoter binding events",
          subtitle = "mRNA and lncRNA genes - HepG2") 


# 2020 data
g <- ggplot(peak_occurence_df_2020, aes(x = number_of_dbp))

#AES layer will know to make a histogram since there is only one set of values for x.
g + geom_density(alpha = 0.2, color = "#424242", fill = "#424242") +
  theme_paperwhite() +
  xlab(expression("Number of DBPs")) +
  ylab(expression("Density")) +
  ggtitle("Promoter binding events",
          subtitle = "mRNA and lncRNA genes - K562") 

# 2020 data - only mRNAs
g <- ggplot(peak_occurence_df_2020 %>% filter(peak_occurence_df_2020$gene_type == protein_coding), aes(x = number_of_dbp))

#AES layer will know to make a histogram since there is only one set of values for x.
g + geom_density(alpha = 0.2, color = "#424242", fill = "#424242") +
  theme_paperwhite() +
  xlab(expression("Number of DBPs")) +
  ylab(expression("Density")) +
  ggtitle("Promoter binding events",
          subtitle = "mRNA genes - K562") 


# 2020 data - both mRNAs and ncRNAs 
g <- ggplot(peak_occurence_df_2020, aes(x = number_of_dbp))+
  facet_wrap(gene_type ~ .)

g + geom_density(alpha = 0.2, color = "#424242", fill = "#424242") +
  theme_paperwhite() +
  xlab(expression("Number of DBPs")) +
  ylab(expression("Density")) +
  ggtitle("Promoter binding events",
          subtitle = "mRNA and lncRNA genes - K562") 



# 2020 data - both mRNAs and ncRNAs 
g <- ggplot(peak_occurence_df_2020, aes(x = number_of_dbp))+
  facet_wrap(expression ~ .)

g + geom_density(alpha = 0.2, color = "#424242", fill = "#424242") +
  theme_paperwhite() +
  xlab(expression("Number of DBPs")) +
  ylab(expression("Density")) +
  ggtitle("Promoter binding events",
          subtitle = "mRNA and lncRNA genes - K562") 



# 2020 data - in one image
ggplot(peak_occurence_df_2020, aes(x = number_of_dbp, fill = gene_type, color = gene_type)) +
   geom_density(alpha = 0.3)


# 2021 data - in one image --> main one
ggplot(peak_occurence_df_new, aes(x = number_of_dbp, fill = gene_type, color = gene_type)) +
   geom_density(alpha = 0.3)


```

filter for reservoirs 


```{r}


# filter for reservoirs

reservoir_list_2020 <- peak_occurence_df_2020 %>% filter(peak_occurence_df_2020$reservoir == 1)
gene_w_reservoirs <-reservoir_list_2020$gene_id

reservoir_new_data <- peak_occurence_df_new %>% filter(peak_occurence_df_new$gene_id %in% gene_w_reservoirs)

# make scatter plot 
reservoir_new_data

num_dbp_2020 <- peak_occurence_df_2020 %>%
  dplyr::select(gene_id, gene_type, number_of_dbp) %>%
  dplyr::rename(num_dbp_K562 = number_of_dbp)
num_reservoir_new_data <- reservoir_new_data %>%
  dplyr::select(gene_id, number_of_dbp) %>%
  dplyr::rename(num_dbp_HepG2 = number_of_dbp)


names(peak_occurence_df_2020)
names(gene_w_reservoirs)
comparison_df <- merge(num_dbp_2020, num_reservoir_new_data)


comparison_df <-comparison_df %>% mutate(dbp_HepG2_ratio = num_dbp_HepG2/460) #460
comparison_df <- comparison_df %>% mutate(dbp_K562_ratio = num_dbp_K562/161) #161

```

plot reservoirs 


```{r}

# 2021 data - density plot

g <- ggplot(reservoir_new_data, aes(x = number_of_dbp, fill = gene_type, color = gene_type))

g + geom_density(alpha = 0.3) +
  xlab(expression("Number of DBPs")) +
  ylab(expression("Density")) +
  ggtitle("Promoter binding events of reservoirs",
          subtitle = "mRNA and lncRNA genes - HepG2") 


# scatterplot 
ggplot(comparison_df, aes(x = dbp_HepG2_ratio,
                         y = dbp_K562_ratio)) +
  geom_point()





```

non - reservoirs


```{r}


# non - reservoirs
non_reservoir_list_2020 <- peak_occurence_df_2020 %>% filter(peak_occurence_df_2020$reservoir == 0)
gene_w_reservoirs <-reservoir_list_2020$gene_id

non_reservoir_new_data <- peak_occurence_df_new %>% filter(peak_occurence_df_new$gene_id %in% gene_w_reservoirs)


num_dbp_2020 <- peak_occurence_df_2020 %>%
  dplyr::select(gene_id, gene_type, number_of_dbp) %>%
  dplyr::rename(num_dbp_K562 = number_of_dbp)
num_nonreservoir_new_data <- non_reservoir_new_data %>%
  dplyr::select(gene_id, number_of_dbp) %>%
  dplyr::rename(num_dbp_HepG2 = number_of_dbp)

names(peak_occurence_df_2020)
names(gene_w_reservoirs)

comparison_df_non_reservoir <- merge(num_dbp_2020, num_nonreservoir_new_data)


comparison_df_non_reservoir <-comparison_df %>% mutate(dbp_HepG2_ratio = num_dbp_HepG2/460)
comparison_df_non_reservoir <- comparison_df %>% mutate(dbp_K562_ratio = num_dbp_K562/161) 


```

plot non-reservoirs 


```{r}
g <- ggplot(reservoir_new_data, aes(x = number_of_dbp, fill = gene_type, color = gene_type))

g + geom_density(alpha = 0.3) +
  xlab(expression("Number of DBPs - non-reservoirs")) +
  ylab(expression("Density")) +
  ggtitle("Promoter binding events of non-reservoirs",
          subtitle = "mRNA and lncRNA genes - HepG2") 


# make scatter plot 

ggplot(comparison_df_non_reservoir, aes(x = dbp_HepG2_ratio,
                         y = dbp_K562_ratio)) +
  geom_point()


```

abundantly_bound_gene > 280
high binding promoters

```{r}
# filter for number_of_dbp

head(peak_occurence_df_new)

filtered_peak_occurence_df_new <- peak_occurence_df_new %>% filter(peak_occurence_df_new$number_of_dbp > 280)


ggplot(filtered_peak_occurence_df_new, aes(x = number_of_dbp, fill = gene_type, color = gene_type)) +
   geom_density(alpha = 0.3)

```

filter for reservoirs 

```{r}


# filter for reservoirs

reservoir_list_2020 <- peak_occurence_df_2020 %>% filter(peak_occurence_df_2020$reservoir == 1)
gene_w_reservoirs <-reservoir_list_2020$gene_id

reservoir_new_data_abundant_bound_genes <- filtered_peak_occurence_df_new %>% filter(filtered_peak_occurence_df_new$gene_id %in% gene_w_reservoirs)

# make scatter plot 


num_dbp_2020 <- peak_occurence_df_2020 %>%
  dplyr::select(gene_id, gene_type, number_of_dbp) %>%
  dplyr::rename(num_dbp_K562 = number_of_dbp)
num_reservoir_new_data <- reservoir_new_data_abundant_bound_genes %>%
  dplyr::select(gene_id, number_of_dbp) %>%
  dplyr::rename(num_dbp_HepG2 = number_of_dbp)


names(peak_occurence_df_2020)
names(reservoir_new_data_abundant_bound_genes)
comparison_df_abundant_bound_genes <- merge(num_dbp_2020, num_reservoir_new_data)


comparison_df_abundant_bound_genes <-comparison_df_abundant_bound_genes %>% mutate(dbp_HepG2_ratio = num_dbp_HepG2/460)
comparison_df_abundant_bound_genes <- comparison_df_abundant_bound_genes %>% mutate(dbp_K562_ratio = num_dbp_K562/161) 


```
plot reservoirs 

```{r}

# 2021 data - density plot

g <- ggplot(reservoir_new_data_abundant_bound_genes, aes(x = number_of_dbp, fill = gene_type, color = gene_type))

g + geom_density(alpha = 0.3) +
  xlab(expression("Number of DBPs")) +
  ylab(expression("Density")) +
  ggtitle("Promoter binding events of reservoirs",
          subtitle = "mRNA and lncRNA genes - HepG2") 


# scatterplot 
ggplot(comparison_df_abundant_bound_genes, aes(x = dbp_HepG2_ratio,
                         y = dbp_K562_ratio)) +
  geom_point()


```

non - reservoirs


```{r}


# non - reservoirs
reservoir_list_2020 <- peak_occurence_df_2020 %>% filter(peak_occurence_df_2020$reservoir == 0)
gene_w_reservoirs <-reservoir_list_2020$gene_id

reservoir_new_data_abundant_bound_genes <- filtered_peak_occurence_df_new %>% filter(filtered_peak_occurence_df_new$gene_id %in% gene_w_reservoirs)

# make scatter plot 


num_dbp_2020 <- peak_occurence_df_2020 %>%
  dplyr::select(gene_id, gene_type, number_of_dbp) %>%
  dplyr::rename(num_dbp_K562 = number_of_dbp)
num_reservoir_new_data <- reservoir_new_data_abundant_bound_genes %>%
  dplyr::select(gene_id, number_of_dbp) %>%
  dplyr::rename(num_dbp_HepG2 = number_of_dbp)


names(peak_occurence_df_2020)
names(reservoir_new_data_abundant_bound_genes)
comparison_df_abundant_bound_genes <- merge(num_dbp_2020, num_reservoir_new_data)


comparison_df_abundant_bound_genes <-comparison_df_abundant_bound_genes %>% mutate(dbp_HepG2_ratio = num_dbp_HepG2/460) 
comparison_df_abundant_bound_genes <- comparison_df_abundant_bound_genes %>% mutate(dbp_K562_ratio = num_dbp_K562/161) 

```

plot non-reservoirs 


```{r}
g <- ggplot(reservoir_new_data_abundant_bound_genes, aes(x = number_of_dbp, fill = gene_type, color = gene_type))

g + geom_density(alpha = 0.3) +
  xlab(expression("Number of DBPs - non-reservoirs")) +
  ylab(expression("Density")) +
  ggtitle("Promoter binding events of non-reservoirs",
          subtitle = "mRNA and lncRNA genes - HepG2") 


# make scatter plot 
ggplot(comparison_df_abundant_bound_genes, aes(x = dbp_HepG2_ratio,
                         y = dbp_K562_ratio)) +
  geom_point()

```



```{r}

num_peaks_df_new <- read.csv(file = '/scratch/Shares/rinnclass/Nina/CLASS_2021/analysis/01_global_peak_properties/results/num_peaks_df.csv')
head(num_peaks_df)

```

# filter peak occurance matrix to get DBP that bind >280

```{r}
# 1) open promoter_peak_occurecne_matrix we produced before 

promoter_peak_occurence <- read_tsv(file = '/scratch/Shares/rinnclass/Nina/CLASS_2021/analysis/01_global_peak_properties/results/lncrna_mrna_promoter_peak_occurence_matrix.tsv')
```
!!!!!!!!!!!!!!!!!!!!!!!!! NOT OPENING!

```{r}
# lets make it
promoter_peak_occurence <- count_peaks_per_feature(lncrna_mrna_promoters, filtered_consensus_peaks, type = "occurrence")

seqnames(promoter_peak_occurence) %>% head()
```
!!!!!!!!!!!!!!!!!!!!!!!!!!! why not working?

```{r}
#  use the peak occurence matrix we produced. You could use col sums to filter promoters with , lets say 300 DBPs bound. Then you know all those proteins are binding the same promter

length(high_binding_promoter)
# 36814


high_binding_promoter <- colSums(promoter_peak_occurence) > 300

high_binding_promoter_peak_occurence <- promoter_peak_occurence[,high_binding_promoter]

length(high_binding_promoter_peak_occurence)
#2604980 and not 5663!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
```


```{r}
#  make an object of those promters as columns and all 446 DBPs as rows 
# then do row sums to find which DBP is binding the most at these highly bound promoters
# or make a distribution of how many of the highly bound promoters have the same proteins.
 

colnames(high_binding_promoter_peak_occurence)
rownames(high_binding_promoter_peak_occurence)


high_binding_promoter_peak_occurence_df <- data.frame("dbp" = rownames(high_binding_promoter_peak_occurence),colnames(high_binding_promoter_peak_occurence))

high_binding_promoter_peak_occurence_df <- data.frame("dbp" = rownames(high_binding_promoter_peak_occurence), promoter_peak_occurence)



head(high_binding_promoter_peak_occurence_df)

nrow(high_binding_promoter_peak_occurence_df)
# 460
length(high_binding_promoter_peak_occurence_df)
# 36815



colSums(high_binding_promoter_peak_occurence_df)
rowSums(high_binding_promoter_peak_occurence_df)

```


```{r}

```

```{r}

```

```{r}

```


 So let’s say there are 1,000 promoters with more than 300 binding events — the question is how similar are the binding events (at 446 cutoff that means all DBPs we examined are at the same promoter, but at 300 it could be a variety of combinations of the 446 that result in 300….. 
 
 so one cool thing would be to ask which DBPs are consistently bound at these high binding promoters (the row sum will give you the number of times a given DBP binds the highly bound promoters). 
 
 When we get to clustering (monday) this is also a great way to show similarity of DBP binding profiles (e.g. which proteins bind the same promoters — by knowing which DBPs are most frequent and highly bound promoters we can cluster them to find a group of DBPs that track with highly bound promoters). 
 
 We can discuss more on friday, but you are on the right track if the goal is to find which DBP is common amongst highly bound promoters (and could be nucleator of these promoter binding events etc)…… 
